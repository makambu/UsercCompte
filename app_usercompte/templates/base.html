{% extends 'head/home.html' %}
{% load static %}

{% block content %}
{% include 'includ/navbar.html' %}

<style>
  .profil-img {
    width: 100%;
    height: 250px;
    object-fit: fill;
    border-radius: 29px;
  }

  .card {
    margin: auto;
    border-radius: 30px;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .biographie {
    flex-grow: 1;
    overflow: hidden;
  }

  .blink {
    background-color: #28a745;
    border-radius: 50%;
    width: 10px;
    height: 10px;
    display: inline-block;
    animation: blink-animation 1s infinite;
  }

  @keyframes blink-animation {
    0% {
      opacity: 1;
    }

    50% {
      opacity: 0.3;
    }

    100% {
      opacity: 1;
    }
  }

  .custom-shadow-btn {
  position: relative;
  background-color: black;
  color: white;
  font-weight: bold;
  font-size: 14px;
  border-radius: 12px;
  border: none;
  width: 130px;
  padding: 8px 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  overflow: hidden;
}

.custom-shadow-btn:hover {
  box-shadow: 0 6px 20px rgba(4, 8, 255, 0.8);
  transform: translateY(-4px);
  color: var(--main-color);
  background-color: white;
}

/* Animation pulsante circulaire */
.pulse-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 120%;
  height: 120%;
  background-color: rgba(0, 128, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: pulse 2s infinite;
  z-index: 0;
}

.pulsating-btn {
  z-index: 1;
}

/* Entr√©e douce en fondu glissant */
.animated-fade-in {
  animation: fadeInUp 1s ease forwards;
  opacity: 0;
  transform: translateY(10px);
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0% {
    transform: translate(-50%, -50%) scale(0.95);
    opacity: 0.5;
  }
  70% {
    transform: translate(-50%, -50%) scale(1.4);
    opacity: 0;
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.95);
  }
}

  .pulse {
    animation: pulseBadge 1.2s infinite;
  }

  @keyframes pulseBadge {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.4);
      opacity: 0.6;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }
  .story-circle {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #007bff;
    transition: transform 0.3s ease;
  }

  .story-circle:hover {
    transform: scale(1.1);
  }
  .modal-content {
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  }

  .modal-body input[type="file"] {
    cursor: pointer;
  }

  #contenuModaleStory {
    padding: 0 !important;
  }
  #storyModal .modal-content,
#storyLikesModal .modal-content {
  transition: all 0.3s ease-in-out;
}

#storyContent img,
#storyContent video {
  max-height: 400px;
  object-fit: contain;
  border-radius: 12px;
  background-color: #000;
}

#storyLikesContent img {
  border: 2px solid #ccc;
}
.assistant-wrapper {
    position: fixed;
    top: 85px;
    right: 1px;
    z-index: 1050;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .btn-assistant-ai {
    width: 55px;
    height: 55px;
    background: linear-gradient(45deg, #0d6efd, #00c6ff);
    color: white;
    font-size: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    position: relative;
    transition: transform 0.3s ease;
  }

  .btn-assistant-ai:hover {
    transform: scale(1.1);
    background: linear-gradient(45deg, #007bff, #00b3e6);
  }

  .bubble-help {
    margin-top: 8px;
    padding: 1px 1px;
    background: #fff;
    color: #0d6efd;
    font-size: 14px;
    font-weight: 500;
    border-radius: 20px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: none;
  }

  .assistant-wrapper:hover .bubble-help {
    opacity: 1;
    transform: translateY(0);
  }

  /* Point rouge de notification */
  .notif-dot {
    position: absolute;
    top: 5px;
    right: 1px;
    width: 10px;
    height: 10px;
    background: red;
    border-radius: 50%;
    box-shadow: 0 0 0 2px white;
  }

  /* Animation pulsante */
  .pulse-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgb(250, 0, 0);
    animation: pulse 1.5s infinite ease-in-out;
    z-index: -1;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 0.8;
    }
    70% {
      transform: scale(1.7);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 0;
    }
  }
</style>

<!-- Carousel -->
<div id="messageSlider" class="carousel slide mt-4" data-bs-ride="carousel">
  <div class="carousel-inner">
    <div class="carousel-item active">
      <img src="{% static 'images/Ima_3.jpg' %}" class="d-block" alt="Slider message"
        style="height: 300px; width: 100%; object-fit: fill; object-position: top;">
      <div class="carousel-caption">
        <h5 style="font-weight: bold; font-size: 30px;">Naviguer sans limite !!!</h5>
        <p class="fw-bold">Connectez-vous pour g√©rer votre compte utilisateur et d√©couvrir les profils des autres.</p>
      </div>
    </div>
  </div>
</div>

{% if utilisateur_connecte %}
<!-- Bouton flottant IA avec animation -->
<div class="assistant-wrapper">
  <a href="{% url 'chatbot_view' %}" title="Parlez √† CgmIA" class="btn-assistant-ai" id="btnAssistantAI">
    <i class="bi bi-robot"></i>
    <span class="pulse-ring"></span>
    <span class="notif-dot"></span>
  </a>
  <div class="bubble-help">Besoin d‚Äôaide ?</div>
</div>
{% endif %}





<!-- Zone des stories utilisateurs -->
  <div class="container mt-2">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold mb-0 text-primary fs-3"><i class="bi bi-camera-reels-fill me-2"></i>Stories</h5>
      {% if utilisateur_connecte %}
      <!-- Bouton Ajouter Story -->
      <a href="#" onclick="document.getElementById('inputStoryDirect').click()" class="position-relative d-inline-block">
        <div class="rounded-circle bg-gradient shadow d-flex align-items-center justify-content-center" title="Ajout un story"
          style="width: 65px; height: 65px; background: linear-gradient(45deg, #000000, #fad106); border: 1px solid var(--bs-primary); z-index: 1;">
          <i class="bi bi-plus fs-2 fw-bold text-primary"></i>
        </div>
      </a>

      <!-- INPUT FICHIER CACH√â -->
      <input type="file" id="inputStoryDirect" accept="image/*,video/*" style="display: none;"
        onchange="envoyerStoryDirect(this)">

      {% endif %}
    </div>

    <div class="d-flex overflow-auto" style="gap: 12px; padding: 8px 5px;">
      {% for story in stories %}
      <a href="javascript:void(0);" onclick="openStoryModal({{ story.auteur.id }})" class="text-decoration-none"
        title="{{ story.auteur.nom }}">
        <div class="position-relative">
          {% if story.auteur.image_profil %}
          <img src="{{ story.auteur.image_profil.url }}" alt="Story"
            class="rounded-circle border border-3 border-primary shadow"
            style="width: 65px; height: 65px; object-fit: fill;">
          {% else %}
          <img src="{% static 'images/image_4.png' %}" alt="Story"
            class="rounded-circle border border-3 border-primary shadow"
            style="width: 65px; height: 65px; object-fit: fill;">
          {% endif %}
        </div>
      </a>
      {% endfor %}
      {% if not stories %}
      <p class="text-muted">Aucune story disponible pour l‚Äôinstant.</p>
      {% endif %}
    </div>
  </div>



<!-- Titre -->
<div class="container mt-2">
  <div class="row">
    <div class="col-12">
      <h4 class="mb-3 fw-bold">üë§ View the accounts users | Online</h4>
      <hr style="border-color: rgb(121, 119, 119);">
    </div>
  </div>
</div>

<!-- Cartes utilisateurs -->
{% now "U" as now %}
<div class="container">
  <div class="row">
    {% if utilisateurs %}
    {% for user in utilisateurs %}
    <div class="col-md-4 mb-4 col-lg-3 d-flex">
      <div class="card shadow w-100 h-100">
        {% if user.image_profil %}
        <img src="{{ user.image_profil.url }}" class="card-img-top profil-img img-fluid" alt="{{ user.nom }}">
        {% else %}
        <img src="{% static 'images/image_4.png' %}" class="card-img-top profil-img img-fluid" alt="Default">
        {% endif %}

        <div class="card-body d-flex flex-column">
          <h6 class="fw-bold">{{ user.nom }} {{ user.prenom }}</h6>
          <p class="card-text text-muted mb-1 biographie" style="font-size: 13px;">
            {{ user.biographie|default:"Aucune biographie disponible."|truncatechars:100 }}
          </p>

          {% if user.derniere_connexion %}
          {% if user.derniere_connexion|date:"U"|add:"0"|floatformat:"0" <= now|add:"-300"|floatformat:"0" %} <small
            class="text-muted d-block">
            <i class="fa fa-clock-o me-1"></i>Deconnected : {{ user.derniere_connexion|date:"d/m/Y H:i" }}
            </small>
            {% endif %}
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mt-auto pt-3">
              <div class="d-flex align-items-center">
                {% if user.derniere_connexion %}
                {% if user.is_online %}
                <span class="blink me-1"></span>
                <small class="text-success fw-bold">En ligne</small>
                {% else %}
                <small class="text-muted">Hors ligne</small>
                {% endif %}
                {% endif %}
              </div>
              <a href="{% url 'voir_profil' user.id %}" class="btn custom-shadow-btn pulsating-btn animated-fade-in">
                Voir plus... <i class="fa fa-eye ms-1" aria-hidden="true"></i>
                <span class="pulse-ring"></span>
              </a>
            </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12 text-center text-danger fw-bold mt-3">
      Aucun utilisateur trouv√© pour ¬´ {{ search_query }} ¬ª
    </div>
    {% endif %}
  </div>
</div>

<!-- MODAL PRINCIPAL POUR AFFICHER UNE STORY -->
<div class="modal fade" id="storyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content bg-black text-white rounded-4 shadow-lg border-0" style="overflow: hidden;">
      
      <!-- Header avec avatar + nom -->
      <div class="modal-header border-0 px-4 pt-3 pb-2">
        <h6 class="modal-title fw-semibold fs-6 d-flex align-items-center gap-2" id="storyAuthorName">
          <!-- Inject√© dynamiquement -->
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <!-- Barre de progression dynamique -->
      <div id="storyProgressBar" class="progress rounded-0" style="height: 2px;">
        <!-- La couleur sera modifi√©e par JS : bg-primary ou bg-white -->
        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
      </div>

      <!-- Zone du contenu -->
      <div id="storyContainer" class="position-relative bg-black text-center" style="min-height: 320px;">
        <div id="storyContent" class="p-3"></div>

        <!-- Navigation gauche/droite -->
        <button onclick="previousStory()" class="btn btn-light rounded-circle shadow-sm position-absolute top-50 start-0 translate-middle-y ms-2" style="width: 36px; height: 36px;">
          <i class="fas fa-chevron-left small"></i>
        </button>
        <button onclick="nextStory()" class="btn btn-light rounded-circle shadow-sm position-absolute top-50 end-0 translate-middle-y me-2" style="width: 36px; height: 36px;">
          <i class="fas fa-chevron-right small"></i>
        </button>

        <!-- Contr√¥les bas : pause et likes -->
        <div class="position-absolute bottom-0 start-0 m-3">
          <button onclick="togglePause()" class="btn btn-outline-light btn-sm rounded-pill px-3">
            <i id="pauseIcon" class="fas fa-pause"></i>
          </button>
        </div>

        <div class="position-absolute bottom-0 end-0 m-3 d-flex align-items-center gap-2" id="likeStorySection">
          <!-- Inject√© via JS -->
        </div>
      </div>
    </div>
  </div>
</div>



<!-- MODALE POUR VOIR LES UTILISATEURS QUI ONT AIM√â -->
<div class="modal fade" id="storyLikesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content rounded-4 shadow-sm border-0">
      <div class="modal-header bg-light border-bottom-0 rounded-top-4">
        <h6 class="modal-title mb-0">Personnes ayant aim√©</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body p-3" id="storyLikesContent">
        <div class="text-center text-muted">Chargement...</div>
      </div>
    </div>
  </div>
</div>






<br>

<!-- Conteneur pour toasts -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 9999;"></div>

<audio id="ringtone" src="{% static 'sounds/ringtone.mp3' %}" preload="auto"></audio>

<script>
  // Lecture du son de notification au premier clic (pour contourner les blocages navigateur)
  document.addEventListener("click", () => {
    const son = document.getElementById("ringtone");
    if (son) son.play().then(() => son.pause()).catch(() => {});
  }, { once: true });

  let sonnerieTimeout = null;
  const son = document.getElementById("ringtone");

  function jouerSonnerieNotification() {
    if (!son) return;
    son.currentTime = 0;
    son.play().catch(e => console.warn("Son bloqu√© :", e));
    if (sonnerieTimeout) clearTimeout(sonnerieTimeout);
    sonnerieTimeout = setTimeout(() => {
      son.pause();
    }, 10000);
  }

  function arreterSonnerie() {
    if (son) son.pause();
    if (sonnerieTimeout) clearTimeout(sonnerieTimeout);
  }

  // Choix du protocole WS/WSS selon HTTPS ou HTTP
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";

  // WebSocket Notifications - Connexion globale √† toutes les pages
  const notifSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

  notifSocket.onopen = function () {
    console.log("WebSocket Notifications connect√©.");
  };

  notifSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    console.log("üì• Notification re√ßue :", data);

    if (data.type === "new_message_notification") {
      mettreAJourBadgeSolola(null);
      jouerSonnerieNotification();

      fetch(`/ajax/nom_utilisateur/${data.from_id}/`)
        .then(res => res.json())
        .then(info => {
          afficherToast(info.nom, info.last_message || "");
          envoyerNotificationDesktop("üí¨ Nouveau message", `De ${info.nom}`);
        });
    }

    if (data.type === "remove_message_notification") {
      mettreAJourBadgeSolola(null);
      arreterSonnerie();
    }
  };

  notifSocket.onerror = function (e) {
    console.error("Erreur WebSocket Notifications :", e);
  };

  notifSocket.onclose = function () {
    console.warn("WebSocket Notifications ferm√©.");
  };

  // V√©rification p√©riodique des messages non lus (fallback)
  function verifierMessagesNonLus() {
    fetch("{% url 'verifier_messages' %}")
      .then(res => res.json())
      .then(data => {
        if (data.status === "jouer_sonnerie") {
          const son = document.getElementById("ringtone");
          if (son) son.play().catch(() => {});
        }
      });
  }

  // Mise √† jour du badge de notification de messages
  function mettreAJourBadgeSolola(nb = null) {
    const badge = document.getElementById("sololaBadge");
    const count = document.getElementById("sololaCount");
    if (!badge || !count) return;

    if (nb !== null) {
      if (nb > 0) {
        badge.classList.remove("d-none");
        badge.classList.add("clignote");
        count.textContent = nb;
      } else {
        badge.classList.add("d-none");
        badge.classList.remove("clignote");
        count.textContent = "0";
      }
    } else {
      fetch("{% url 'nb_messages_non_lus' %}")
        .then(res => res.json())
        .then(data => {
          if (data.nb > 0) {
            badge.classList.remove("d-none");
            badge.classList.add("clignote");
            count.textContent = data.nb;
          } else {
            badge.classList.add("d-none");
            badge.classList.remove("clignote");
            count.textContent = "0";
          }
        });
    }
  }

  // Intervalles de v√©rification r√©guli√®re
  setInterval(verifierMessagesNonLus, 30000);
  setInterval(() => mettreAJourBadgeSolola(null), 15000);

  // -----------------------------------------------------------
  // Partie chat (uniquement si sur page chat)

  const messageForm = document.getElementById("messageForm");
  const chatBox = document.getElementById("chatBox");

  {% if user_cible %}
  const expediteurId = Number("{{ utilisateur_connecte.id }}");
  const destinataireId = Number("{{ user_cible.id }}");
  const expediteurNom = "{{ utilisateur_connecte.nom }}";

  const roomName = `${Math.min(expediteurId, destinataireId)}_${Math.max(expediteurId, destinataireId)}`;
  const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${roomName}/`);

  chatSocket.onopen = function () {
    console.log("üì° WebSocket Chat connect√©.");
    chatSocket.send(JSON.stringify({
      type: "messages_read",
      expediteur_id: destinataireId,
      destinataire_id: expediteurId
    }));
    arreterSonnerie();
  };

  chatSocket.onclose = function () {
    console.warn("WebSocket Chat ferm√©.");
  };

  chatSocket.onerror = function (e) {
    console.error("Erreur WebSocket Chat :", e);
  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    console.log("üì© Message WebSocket re√ßu :", data);

    if (!chatBox) return;

    // Gestion appel vocal entrant
    if (data.type === "call_incoming") {
      const callModal = document.getElementById("callModal");
      const callUserName = document.getElementById("callUserName");
      const ringtone = document.getElementById("ringtone");
      if (callUserName && callModal && ringtone) {
        callUserName.innerText = data.from_name;
        callModal.style.display = "flex";
        ringtone.currentTime = 0;
        ringtone.play();
      }
      return;
    }

    if (data.type === "call_answered") {
      const ringtone = document.getElementById("ringtone");
      const callModal = document.getElementById("callModal");
      const endCallBtn = document.getElementById("endCall");
      const rejectCallBtn = document.getElementById("rejectCall");
      const acceptCallBtn = document.getElementById("acceptCall");

      if (ringtone) ringtone.pause();

      if (data.answer === "accept") {
        if (endCallBtn) endCallBtn.classList.remove("d-none");
        if (rejectCallBtn) rejectCallBtn.classList.add("d-none");
        if (acceptCallBtn) acceptCallBtn.classList.add("d-none");
      } else {
        if (callModal) callModal.style.display = "none";
        alert("L'utilisateur a rejet√© l'appel.");
      }
      return;
    }

    if (data.type === "call_ended") {
      const ringtone = document.getElementById("ringtone");
      const callModal = document.getElementById("callModal");
      if (ringtone) ringtone.pause();
      if (callModal) callModal.style.display = "none";
      alert("L'appel a √©t√© termin√©.");
      return;
    }

    // Affichage message texte/fichier
    const div = document.createElement("div");
    div.className = "message " + (data.expediteur_id == expediteurId ? "envoye" : "recu");

    let contenu = "";
    if (data.message) contenu += `<p>${data.message}</p>`;
    if (data.file_url) {
      const ext = data.file_ext.toLowerCase();
      if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
        contenu += `<img src="${data.file_url}" style="max-width:100%; max-height:300px;"><br>`;
      } else if (["mp4", "webm"].includes(ext)) {
        contenu += `<video controls style="width:100%;"><source src="${data.file_url}"></video><br>`;
      } else if (["mp3", "wav", "webm"].includes(ext)) {
        contenu += `<audio controls style="width:100%;"><source src="${data.file_url}"></audio><br>`;
      } else if (["pdf"].includes(ext)) {
        contenu += `<iframe src="https://docs.google.com/gview?url=${data.file_url}&embedded=true" style="width:100%; height:400px;" frameborder="0"></iframe><br>`;
      } else if (["doc", "docx", "xls", "xlsx", "ppt", "pptx"].includes(ext)) {
        contenu += `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${data.file_url}" style="width:100%; height:400px;" frameborder="0"></iframe><br>`;
      } else {
        contenu += `<a href="${data.file_url}" target="_blank" class="btn btn-outline-secondary">üìÅ Voir le fichier</a><br>`;
      }
      contenu += `<a href="${data.file_url}" download class="btn btn-sm btn-outline-primary mt-1">üì• T√©l√©charger</a>`;
    }

    contenu += `<small>${data.expediteur_id == expediteurId ? "Moi" : data.expediteur} ‚Ä¢ Maintenant</small>`;
    div.innerHTML = contenu;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  // Envoi message texte
  if (messageForm) {
    const inputText = messageForm.elements.contenu;
    messageForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const message = inputText.value.trim();
      if (!message) return;

      chatSocket.send(JSON.stringify({
        message: message,
        expediteur_id: expediteurId,
        expediteur_nom: expediteurNom,
        destinataire_id: destinataireId
      }));

      inputText.value = "";
    });
  }

  // Envoi fichiers
  const fileInput = document.getElementById("fileInput");
  if (fileInput) {
    fileInput.addEventListener("change", function () {
      if (fileInput.files.length === 0) return;
      const file = fileInput.files[0];
      const reader = new FileReader();

      const tempMsg = document.createElement("div");
      tempMsg.className = "message envoyee uploading-message";
      tempMsg.textContent = `Envoi de ¬´ ${file.name} ¬ª en cours...`;
      chatBox.appendChild(tempMsg);
      chatBox.scrollTop = chatBox.scrollHeight;

      reader.onload = function () {
        chatSocket.send(JSON.stringify({
          file: reader.result,
          file_name: file.name,
          expediteur_id: expediteurId,
          expediteur_nom: expediteurNom,
          destinataire_id: destinataireId
        }));
        fileInput.value = "";
        setTimeout(() => tempMsg.remove(), 1500);
      };

      reader.readAsDataURL(file);
    });
  }

  // Enregistrement vocal
  let mediaRecorder;
  let recordedChunks = [];

  const recordBtn = document.getElementById("recordBtn");
  const recordingStatus = document.getElementById("recordingStatus");

  if (recordBtn) {
    recordBtn.addEventListener("click", async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          recordedChunks = [];

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: "audio/webm" });
            const reader = new FileReader();
            reader.onloadend = () => {
              chatSocket.send(JSON.stringify({
                file: reader.result,
                file_name: `voice_${Date.now()}.webm`,
                expediteur_id: expediteurId,
                expediteur_nom: expediteurNom,
                destinataire_id: destinataireId
              }));
            };
            reader.readAsDataURL(blob);
          };

          mediaRecorder.start();
          if(recordingStatus) recordingStatus.style.display = "inline";
          recordBtn.innerHTML = `<i class="fas fa-stop"></i>`;

          setTimeout(() => {
            if (mediaRecorder.state === "recording") {
              mediaRecorder.stop();
              if(recordingStatus) recordingStatus.style.display = "none";
              recordBtn.innerHTML = `<i class="fas fa-microphone"></i>`;
            }
          }, 20000);
        } catch (err) {
          alert("‚ö†Ô∏è Impossible d'acc√©der au microphone : " + err.message);
        }
      } else if (mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        if(recordingStatus) recordingStatus.style.display = "none";
        recordBtn.innerHTML = `<i class="fas fa-microphone"></i>`;
      }
    });
  }

  // Gestion appels vocaux
  const callBtn = document.getElementById("callBtn");
  const callModal = document.getElementById("callModal");
  const ringtone = document.getElementById("ringtone");
  const callUserName = document.getElementById("callUserName");
  const acceptCallBtn = document.getElementById("acceptCall");
  const rejectCallBtn = document.getElementById("rejectCall");
  const endCallBtn = document.getElementById("endCall");

  if (callBtn) {
    callBtn.addEventListener("click", () => {
      alert("‚è≥ Cette fonctionnalit√© d'appel vocal sera bient√¥t disponible. Merci de votre patience !");
      return;
      // Code appel vocal √† activer plus tard
      chatSocket.send(JSON.stringify({
        type: "call_start",
        expediteur_id: expediteurId,
        destinataire_id: destinataireId,
        from_name: expediteurNom
      }));
      callUserName.textContent = `avec ${document.querySelector('.user-name').textContent}`;
      callModal.style.display = "flex";
      if(ringtone) ringtone.play();
    });
  }

  if (acceptCallBtn) {
    acceptCallBtn.addEventListener("click", () => {
      chatSocket.send(JSON.stringify({
        type: "call_answer",
        answer: "accept",
        from_id: expediteurId
      }));
      if(ringtone) ringtone.pause();
      if(endCallBtn) endCallBtn.classList.remove("d-none");
      if(rejectCallBtn) rejectCallBtn.classList.add("d-none");
      if(acceptCallBtn) acceptCallBtn.classList.add("d-none");
    });
  }

  if (rejectCallBtn) {
    rejectCallBtn.addEventListener("click", () => {
      chatSocket.send(JSON.stringify({
        type: "call_answer",
        answer: "reject",
        from_id: expediteurId
      }));
      if(ringtone) ringtone.pause();
      if(callModal) callModal.style.display = "none";
    });
  }

  if (endCallBtn) {
    endCallBtn.addEventListener("click", () => {
      chatSocket.send(JSON.stringify({
        type: "call_end",
        from_id: expediteurId
      }));
      if(callModal) callModal.style.display = "none";
      if(ringtone) ringtone.pause();
    });
  }

  // Emoji panel
  const emojiBtn = document.getElementById("emojiBtn");
  const emojiPanel = document.getElementById("emojiPanel");
  const inputMsg = document.querySelector("input[name='contenu']");

  if (emojiBtn && emojiPanel && inputMsg) {
    emojiBtn.addEventListener("click", () => {
      if (emojiPanel.style.display === "block") {
        emojiPanel.style.display = "none";
        return;
      }

      emojiPanel.style.visibility = "hidden";
      emojiPanel.style.display = "block";

      const rect = emojiBtn.getBoundingClientRect();
      const scrollY = window.scrollY;
      const scrollX = window.scrollX;

      emojiPanel.style.left = `${rect.left + scrollX}px`;
      emojiPanel.style.top = `${rect.top + scrollY - emojiPanel.offsetHeight - 8}px`;

      emojiPanel.style.visibility = "visible";
    });

    // Liste des emojis
    const emojis = ["üòÄ", "üòÇ", "üòç", "üòò", "üòé", "üò¢", "ü§î", "üôå", "üî•", "üéâ", "üíØ", "‚ù§Ô∏è", "ü§©", "üò°", "üòá", "üòú", "ü§ó", "üíñ", "üíî", "üò±", "üëè", "üëç", "üëé", "üôè",
      "üòÅ", "üòÖ", "ü§£", "üôÇ", "üôÉ", "üòâ", "ü•∞", "ü§©", "üòó", "‚ò∫Ô∏è", "üòö", "üòã", "üòú", "ü§™", "ü§ë", "ü§ó", "ü§≠", "ü§´",
      "ü§î", "ü§ê", "ü§®", "üòê", "üòë", "üò∂", "üòè", "üòí", "üôÑ", "üò¨", "ü§•", "üòå", "üòî", "üò™", "ü§§", "üò¥", "üò∑", "ü§í", "ü§ï", "ü§¢",
      "ü§Æ", "ü•µ", "ü•∂", "üòµ", "ü§Ø", "ü§†", "ü•≥", "üòé", "ü§ì", "üßê", "üòï", "üòü", "üôÅ", "‚òπÔ∏è", "üòÆ", "üòØ", "üò≤", "üò≥", "ü•∫", "üò¶",
      "üòß", "üò®", "üò∞", "üò•", "üò¢", "üò≠", "üò±", "üòñ", "üò£", "üòû", "üòì", "üò©", "üò´", "ü•±", "üò§", "üò†", "ü§¨", "üòà", "üëø", "üíÄ",
      "‚ò†Ô∏è", "üí©", "ü§°", "üëπ", "üë∫", "üëª", "üëΩ", "üëæ", "ü§ñ", "üéÉ", "üò∫", "üòπ", "üòª", "üòº", "üôÄ", "üòø", "üòæ",
      "üíï", "üíñ", "üíó", "üíì", "üíû", "üíã", "üéâ", "üéä", "üéÆ", "üé¨", "üé≠", "üéµ", "üé§", "üéß", "üéº", "üéπ", "ü•Å", "üé∑", "üé∫", "üé∏"];

    emojis.forEach(emoji => {
      const span = document.createElement("span");
      span.textContent = emoji;
      span.style.cursor = "pointer";
      span.style.fontSize = "20px";
      span.style.margin = "4px";
      span.addEventListener("click", () => {
        inputMsg.value += emoji;
        emojiPanel.style.display = "none";
        inputMsg.focus();
      });
      emojiPanel.appendChild(span);
    });
  }

  // Toast notifications (Bootstrap 5)
  function afficherToast(titre, message) {
    if (!("bootstrap" in window)) return;

    const toastContainerId = "toastContainerGlobal";
    let toastContainer = document.getElementById(toastContainerId);
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.id = toastContainerId;
      toastContainer.style.position = "fixed";
      toastContainer.style.top = "20px";
      toastContainer.style.right = "20px";
      toastContainer.style.zIndex = "1060";
      document.body.appendChild(toastContainer);
    }

    const toastEl = document.createElement("div");
    toastEl.className = "toast align-items-center text-white bg-primary border-0";
    toastEl.setAttribute("role", "alert");
    toastEl.setAttribute("aria-live", "assertive");
    toastEl.setAttribute("aria-atomic", "true");
    toastEl.style.minWidth = "250px";

    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <strong>${titre}</strong><br>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
      </div>
    `;

    toastContainer.appendChild(toastEl);

    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();

    toastEl.addEventListener("hidden.bs.toast", () => {
      toastEl.remove();
    });
  }

  // Notifications desktop (permission requise)
  function envoyerNotificationDesktop(titre, message) {
    if (!("Notification" in window)) return;

    if (Notification.permission === "granted") {
      new Notification(titre, { body: message, icon: "/static/img/notification_icon.png" });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification(titre, { body: message, icon: "/static/img/notification_icon.png" });
        }
      });
    }
  }
{% endif %}
</script>


<script>
    let isNavigating = false;

    // Quand l'utilisateur clique sur un lien interne ‚Üí navigation normale
    document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            isNavigating = true;
        });
    });

    // Idem pour les formulaires (comme logout manuel ou formulaire blog)
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', () => {
            isNavigating = true;
        });
    });

    // Maintenant on intercepte uniquement si l'utilisateur ferme ou actualise (beforeunload) sendBeacon
    window.addEventListener("beforeunload", function () {
        if (!isNavigating) {
            if (navigator.sendBeacon) {
                const data = new FormData();
                navigator.beforeunload("{% url 'logout_ajax' %}", data);
            } else {
                fetch("{% url 'logout_ajax' %}", {
                    method: "POST",
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                });
            }
        }
    });
</script>


<script>
let storyTimeout = null;
let storyIndex = 0;
let storyList = [];
let paused = false;
let progress = 0;
let interval = null;
let estProprietaireStory = false;
let storiesVues = new Set(); // Pour marquer les stories vues

function openStoryModal(userId) {
  fetch(`/ajax/stories/${userId}/`)
    .then(response => response.json())
    .then(data => {
      storyList = data.stories;
      storyIndex = 0;
      estProprietaireStory = data.est_proprietaire;

      document.getElementById("storyAuthorName").innerHTML = `
        <img src="${data.image_profil}" class="rounded-circle me-2" style="width: 30px; height: 30px;">
        ${data.nom}`;

      const modalEl = document.getElementById("storyModal");
      const modalInstance = new bootstrap.Modal(modalEl);
      modalInstance.show();

      showStory();

      modalEl.addEventListener("hide.bs.modal", () => {
        clearTimeout(storyTimeout);
        clearInterval(interval);
        stopVideo();
        document.getElementById("storyContent").innerHTML = "";
      });
    });
}

function showStory() {
  if (storyIndex >= storyList.length) {
    bootstrap.Modal.getInstance(document.getElementById("storyModal")).hide();
    return;
  }

  const story = storyList[storyIndex];
  const contentContainer = document.getElementById("storyContent");
  const progressBar = document.querySelector("#storyProgressBar .progress-bar");

  let content = "";

  if (story.type === "image") {
    content = `<img src="${story.media_url}" class="w-100" style="max-height:500px; object-fit:contain;">`;
  } else if (story.type === "video") {
    content = `<video id="storyVideo" class="w-100" style="max-height:500px;" autoplay muted  controls>
                 <source src="${story.media_url}" type="video/mp4">
               </video>`;
  }

  contentContainer.innerHTML = `
    ${content}
    <p class="mt-2 mb-0">${story.description || ''}</p>
    <small class="text-muted">${story.date}</small>
  `;

  // Ajouter l‚ÄôID √† la liste des vues
  storiesVues.add(story.id);

  // Couleur de la barre selon vue
  progressBar.className = `progress-bar ${storiesVues.has(story.id) ? 'bg-primary' : 'bg-white'}`;
  progressBar.style.width = "0%";

  // Zone de like
  const likeSection = document.getElementById("likeStorySection");
  if (estProprietaireStory) {
    likeSection.innerHTML = `
      <i class="fas fa-heart text-danger me-1"></i>
      <span onclick="afficherLikesStory()" style="cursor:pointer">${story.likes || 0}</span>
    `;
  } else {
    likeSection.innerHTML = `
      <i class="${story.is_liked ? 'fas' : 'far'} fa-heart"
         style="cursor:pointer; color:${story.is_liked ? 'red' : 'white'}"
         onclick="toggleLikeStory()"></i>
    `;
  }

  // Progression
  progress = 0;
  clearInterval(interval);

  const duration = story.type === "image" ? 5000 : 15000;
  const step = 100 / (duration / 100);

  interval = setInterval(() => {
    if (!paused) {
      progress += step;
      progressBar.style.width = `${progress}%`;
      if (progress >= 100) {
        clearInterval(interval);
        storyIndex++;
        showStory();
      }
    }
  }, 100);
}

function togglePause() {
  paused = !paused;
  const icon = document.getElementById("pauseIcon");
  icon.className = paused ? "fas fa-play" : "fas fa-pause";
}

function nextStory() {
  clearInterval(interval);
  storyIndex++;
  showStory();
}

function previousStory() {
  clearInterval(interval);
  storyIndex = Math.max(0, storyIndex - 1);
  showStory();
}

function stopVideo() {
  const video = document.getElementById("storyVideo");
  if (video) {
    video.pause();
    video.removeAttribute("src");
    video.load();
  }
}

// ‚ù§Ô∏è Liker une story
function toggleLikeStory() {
  const story = storyList[storyIndex];
  fetch(`/ajax/story/${story.id}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        story.is_liked = data.is_liked;
        story.likes = data.total_likes;
        showStory();
      }
    });
}

// üë• Afficher les utilisateurs ayant aim√©
function afficherLikesStory() {
  paused = true; // Met en pause
  document.getElementById("pauseIcon").className = "fas fa-play";

  const story = storyList[storyIndex];
  fetch(`/ajax/story/${story.id}/likes/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("storyLikesContent");
      if (data.users.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucun utilisateur pour l‚Äôinstant</p>';
      } else {
        container.innerHTML = data.users.map(u => `
          <div class="d-flex align-items-center mb-2">
            <img src="${u.image}" class="rounded-circle me-2" style="width: 35px; height: 35px;">
            <span>${u.nom}</span>
          </div>`).join('');
      }
      new bootstrap.Modal(document.getElementById("storyLikesModal")).show();
    });
}

// üîí Token CSRF
function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let i = 0; i < cookies.length; i++) {
    const c = cookies[i].trim();
    if (c.startsWith(name + '=')) {
      return decodeURIComponent(c.substring(name.length + 1));
    }
  }
  return '';
}
</script>



<script>
function envoyerStoryDirect(input) {
  if (input.files.length === 0) return;

  const fichier = input.files[0];
  const formData = new FormData();
  const isVideo = fichier.type.startsWith("video");

  if (isVideo) {
    // Si c'est une vid√©o, upload direct vers Cloudinary
    formData.append("file", fichier);
    formData.append("upload_preset", "story_direct_upload"); // Ton preset unsigned
    formData.append("resource_type", "video");

    fetch("https://api.cloudinary.com/v1_1/dml7j5pjj/video/upload", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        const videoUrl = data.secure_url;
        // Maintenant tu envoies l'URL au backend Django pour l‚Äôenregistrer
        return fetch("{% url 'ajax_ajouter_story' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify({ video_url: videoUrl })
        });
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          alert("Vid√©o story ajout√©e !");
          location.reload();
        } else {
          alert(data.message || "Erreur lors de l'ajout.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Erreur lors de l'envoi vers Cloudinary.");
      });
  } else {
    // Sinon, image ‚Üí backend classique
    formData.append("image", fichier);

    fetch("{% url 'ajax_ajouter_story' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken()
      },
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          alert("Image story ajout√©e !");
          location.reload();
        } else {
          alert(data.message || "Erreur lors de l'ajout.");
        }
      });
  }

  input.value = ""; // Reset
}


function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let c of cookies) {
    c = c.trim();
    if (c.startsWith(name + '=')) {
      return decodeURIComponent(c.substring(name.length + 1));
    }
  }
  return '';
}
</script>








{% endblock content %}