{% extends 'head/home.html' %}
{% load static %}

{% block content %}

{% include 'includ/notification_global.html' %}

<!-- Carousel de bienvenue -->
<div class="carousel-inner mt-4">
  <div class="carousel-item active position-relative">
    <img src="{% static 'images/ima_no.jpg' %}" class="d-block w-100" style="height: 250px; object-fit: fill; object-position: top; border-radius: 8px;">
    <div class="carousel-caption d-flex flex-column mb-0 justify-content-end text-start pb-1" style="bottom: 0; width: 100%; left: 0; right: 0;">
      <h3 class="text-center fw-bold text-white mb-0">Bienvenue dans le monde des notifications</h3>
      <p class="text-center" style="font-weight: 500;">D√©couvrez les personnes ayant aimer et commenter des activit√©s sur ton environnement d'attente.</p>
    </div>
  </div>
</div>

<div class="container pt-3">
  <div class="row">
    <div class="col-12 d-flex align-items-center mt-4 mb-2">
      <a href="{% url 'homes' %}" class="me-3 text-decoration-none text-blue fs-4" title="Retour √† l'accueil">
        <i class="fas fa-chevron-left"></i>
      </a>
      <h4 class="mb-0 fw-bold">üõóÔ∏è Vos notifications</h4>
    </div>
    <hr style="border-color: rgb(121, 119, 119);">
  </div>

  {% if notifications %}
  <div id="notifications-list">
    {% for inv in invitations %}
    <div class="card shadow-sm mb-3" id="invitation-{{ inv.id }}">
        <div class="card-body d-flex align-items-center">
            <a href="{% url 'voir_profil' inv.emetteur.id %}">
                {% if ami.image_profil %}
                <img src="{{ ami.image_profil.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit: fill;">
                {% else %}
                <img src="{% static 'images/image_4.png' %}" class="rounded-circle me-2" width="40" height="40"
                    style="object-fit: fill;">
                {% endif %}
            </a>
            <div class="flex-grow-1">
                <p class="mb-1">
                    <strong><a href="{% url 'voir_profil' inv.emetteur.id %}">{{ inv.emetteur.nom }}</a></strong> vous a
                    envoy√© une invitation d‚Äôamiti√©.
                </p>
                <small class="text-muted">{{ inv.date_envoi|date:"d/m/Y H:i" }}</small>
            </div>
            <div>
                <button onclick="gererInvitation({{ inv.id }}, 'accepter')"
                    class="btn btn-success btn-sm me-1">Accepter</button>
                <button onclick="gererInvitation({{ inv.id }}, 'refuser')" class="btn btn-danger btn-sm">Refuser</button>
            </div>
        </div>
    </div>
    {% endfor %}


    {% for n in notifications %}
    <div class="card shadow-sm mb-3" data-notif-id="{{ n.id }}">
      <div class="card-body d-flex align-items-center">
        <a href="{% url 'voir_profil' n.emetteur.id %}">
          {% if n.emetteur.image_profil %}
          <img src="{{ n.emetteur.image_profil.url }}" class="rounded-circle me-3" width="50" height="50" alt="Image profil">
          {% else %}
          <img src="{% static 'images/image_4.png' %}" class="rounded-circle me-3" width="50" height="50" alt="Image profil">
          {% endif %}
        </a>
        <div class="flex-grow-1">
          <p class="mb-1">
            <strong><a href="{% url 'voir_profil' n.emetteur.id %}">{{ n.emetteur.nom }}</a></strong> ‚Äî {{ n.message }}
          </p>
          <small class="text-muted">{{ n.date|date:"d/m/Y H:i" }}</small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">Aucune notification pour l‚Äôinstant.</div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // Fonction globale pour accepter ou refuser une invitation
  window.gererInvitation = function (id, action) {
    const url = action === 'accepter'
      ? `/invitation-accepter/${id}/`
      : `/invitation-refuser/${id}/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        const div = document.getElementById(`invitation-${id}`);
        if (div) div.remove();
      } else {
        alert("Erreur : " + data.message);
      }
    })
    .catch(() => alert("Erreur r√©seau."));
  };

  // Fonction pour r√©cup√©rer le token CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        c = c.trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

});
</script>

{% endblock %}
