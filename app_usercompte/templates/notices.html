{% extends 'head/home.html' %}
{% load static %}

{% block content %}

{% include 'includ/notification_global.html' %}

<!-- Carousel de bienvenue -->
<div class="carousel-inner mt-4">
    <div class="carousel-item active position-relative">
        <img src="{% static 'images/ima_no.jpg' %}" class="d-block w-100"
            style="height: 250px; object-fit: fill; object-position: top; border-radius: 8px;">
        
        <!-- Zone de texte superpos√©e -->
        <div class="carousel-caption d-flex flex-column mb-0 justify-content-end text-start pb-1"
             style="bottom: 0; width: 100%; left: 0; right: 0;">
            <h3 class="text-center fw-bold text-white mb-0">Bienvenue dans le monde des notifications</h3>
            <p class="text-center" style="font-weight: 500;">D√©couvrez les personnes ayant aimer et commenter des activit√©s sur ton environnement d'attente.</p>
        </div>
    </div>
</div>


<div class="container pt-3">
  <div class="row">
    <div class="col-12 d-flex align-items-center mt-4 mb-2">
      <a href="{% url 'homes' %}" class="me-3 text-decoration-none text-blue fs-4" title="Retour √† l'accueil">
        <i class="fas fa-chevron-left"></i>
      </a>
      <h4 class="mb-0 fw-bold">üõéÔ∏è Vos notifications</h4>
    </div>
    <hr style="border-color: rgb(121, 119, 119);">
  </div>

  {% if notifications %}
  <div id="notifications-list">
    {% for inv in invitations %}
    <div class="card shadow-sm mb-3" data-notif-id="inv_{{ inv.id }}">
        <div class="card-body d-flex align-items-center">
            <a href="{% url 'voir_profil' inv.emetteur.id %}">
                {% if inv.emetteur.image_profil %}
                <img src="{{ inv.emetteur.image_profil.url }}" class="rounded-circle me-3" width="50" height="50">
                {% else %}
                <img src="{% static 'images/image_4.png' %}" class="rounded-circle me-3" width="50" height="50">
                {% endif %}
            </a>
            <div class="flex-grow-1">
                <p class="mb-1">
                    <strong><a href="{% url 'voir_profil' inv.emetteur.id %}">{{ inv.emetteur.nom }}</a></strong> vous a
                    envoy√© une invitation d‚Äôamiti√©.
                </p>
                <small class="text-muted">{{ inv.date_envoi|date:"d/m/Y H:i" }}</small>
            </div>
            <div>
                <button onclick="gererInvitation({{ inv.id }}, 'accepter')" class="btn btn-success btn-sm me-1">Accepter</button>
                <button onclick="gererInvitation({{ inv.id }}, 'refuser')" class="btn btn-danger btn-sm">Refuser</button>
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% for n in notifications %}
    <div class="card shadow-sm mb-3" data-notif-id="{{ n.id }}">
        <div class="card-body d-flex align-items-center">
            {% if n.emetteur and n.emetteur.image_profil %}
            <a href="{% url 'voir_profil' n.emetteur.id %}">
                <img src="{{ n.emetteur.image_profil.url }}" class="rounded-circle me-3" width="50" height="50"
                    alt="Image profil">
            </a>
            {% else %}
            <a href="{% url 'voir_profil' n.emetteur.id %}">
                <img src="{% static 'images/image_4.png' %}" class="rounded-circle me-3" width="50" height="50"
                    alt="Image profil">
            </a>
            {% endif %}
            <div class="flex-grow-1">
                <p class="mb-1">
                    <strong>
                        {% if n.emetteur %}
                        <a href="{% url 'voir_profil' n.emetteur.id %}">{{ n.emetteur.nom }}</a>
                        {% else %}
                        Syst√®me
                        {% endif %}
                    </strong>
                    ‚Äî
                    {% if n.type == 'like_video' %}
                    <i class="bi bi-heart-fill text-danger"></i>
                    {% elif n.type == 'commentaire_video' %}
                    <i class="bi bi-chat-left-text-fill text-success"></i>
                    {% endif %}
                    {{ n.message }}
                </p>
                <small class="text-muted">{{ n.date|date:"d/m/Y H:i" }}</small>
            </div>
        </div>
    </div>
    {% endfor %}

  </div>
  {% else %}
  <div class="alert alert-info">Aucune notification pour l‚Äôinstant.</div>
  {% endif %}
</div>



<script>
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const notifSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

  notifSocket.onopen = () => console.log("‚úÖ WebSocket Notifications connect√©.");
  notifSocket.onerror = (e) => console.error("‚ùå Erreur WebSocket :", e);
  notifSocket.onclose = () => console.warn("‚ö†Ô∏è WebSocket Notifications ferm√©.");

  notifSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("üì© WS re√ßue :", data);

    if (data.type === "invitation_ami") {
      ajouterNotificationInvitation(data.invitation);
    } else if (data.type === "invitation_ami_update") {
      mettreAJourNotificationInvitation(data.invitation_id, data.statut);
    }
  };

  function ajouterNotificationInvitation(inv) {
    const list = document.getElementById('notifications-list');
    if (!list) return;

    if (document.querySelector(`[data-notif-id="inv_${inv.id}"]`)) return;

    const img = inv.emetteur.image || "{% static 'images/image_4.png' %}";
    const nom = inv.emetteur.nom || "Utilisateur";
    const url = `/profil/${inv.emetteur.id}/`;

    const html = `
      <div class="card shadow-sm mb-3" data-notif-id="inv_${inv.id}">
        <div class="card-body d-flex align-items-center">
          <a href="${url}">
            <img src="${img}" class="rounded-circle me-3" width="50" height="50">
          </a>
          <div class="flex-grow-1">
            <p class="mb-1">
              <strong><a href="${url}">${nom}</a></strong> vous a envoy√© une invitation d‚Äôamiti√©.
            </p>
            <small class="text-muted">${new Date(inv.date_envoi).toLocaleString()}</small>
          </div>
          <div>
            <button onclick="gererInvitation(${inv.id}, 'accepter')" class="btn btn-success btn-sm me-2">Accepter</button>
            <button onclick="gererInvitation(${inv.id}, 'refuser')" class="btn btn-danger btn-sm">Refuser</button>
          </div>
        </div>
      </div>`;
    
    list.insertAdjacentHTML("afterbegin", html);
  }

  function mettreAJourNotificationInvitation(inv_id, statut) {
    const card = document.querySelector(`[data-notif-id="inv_${inv_id}"]`);
    if (!card) return;

    const badge = statut === "acceptee"
      ? '<span class="badge bg-success">Invitation accept√©e</span>'
      : '<span class="badge bg-danger">Invitation refus√©e</span>';

    const p = card.querySelector("div.flex-grow-1 p");
    if (p) p.innerHTML += ` ‚Äî ${badge}`;

    const buttons = card.querySelectorAll("button");
    buttons.forEach(btn => btn.remove());
  }

  // Interm√©diaire propre pour ton bouton HTML
  window.gererInvitation = function (id, action) {
    const accepter = action === "accepter";
    const url = accepter
      ? `/invitation-accepter/${id}/`
      : `/invitation-refuser/${id}/`;

    fetch(url, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "ok") {
        mettreAJourNotificationInvitation(id, accepter ? "acceptee" : "refusee");
      } else {
        alert("Erreur : " + (data.message || "Une erreur est survenue."));
      }
    })
    .catch(() => alert("Erreur r√©seau."));
  };

   // ‚õ≥Ô∏è Ajoute ce bloc pour que le onclick fonctionne
window.gererInvitation = function(id, action) {
  repondreInvitation(id, action === 'accepter');
};

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
      const cookies = document.cookie.split(";");
      for (let c of cookies) {
        c = c.trim();
        if (c.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>



{% endblock %}

